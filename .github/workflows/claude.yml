name: Update README with Claude

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch recent GitHub activity
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching user profile..."
          gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /users/nguyenvanduocit > user_profile.json || echo '{"login":"nguyenvanduocit","name":"Developer"}' > user_profile.json

          echo "Fetching repositories..."
          gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" "/users/nguyenvanduocit/repos?per_page=10&sort=updated" > recent_repos.json || echo '[]' > recent_repos.json

          echo "Fetching public events..."
          gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" "/users/nguyenvanduocit/events/public?per_page=30" > recent_activity.json || echo '[]' > recent_activity.json

          echo "Data fetching complete."
          ls -la *.json

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          claude_args: |
            --allowedTools Edit,Read,Write,Bash,Glob,Grep
          prompt: |
            Update my README.md profile based on recent GitHub activity.

            Read: user_profile.json, recent_activity.json, recent_repos.json, README.md

            CRITICAL: Keep README under 40 lines total. Be extremely concise.

            Structure (use this exact format):
            ```
            ## Hi, I'm Duoc Nguyen ðŸ‘‹

            Pi-shaped engineer: Backend/AI tooling (Go, TS) Ã— AI agents/MCP Ã— Product iteration

            ### Projects
            - **[project](url)** â€” one-line description (stars if notable)
            [max 6 projects, one line each]

            ### Now
            [2-3 bullet points of current focus from recent activity]

            ### Stack
            Go, TypeScript, MCP, real-time systems, developer tooling

            ### Connect
            [12bit.vn](https://12bit.vn) Â· Viá»‡t Nam

            ---
            *Updated: YYYY-MM-DD*
            ```

            Rules:
            - MAX 40 lines, no exceptions
            - One line per project, no paragraphs
            - No redundant sections (no "How I work", "Product thinking", "Technical depth")
            - Never mention all-in-one-model-context-protocol or dev-kit
            - Commit and push after updating

            ALSO generate profile.json with this structure:
            ```json
            {
              "name": "Duoc Nguyen",
              "tagline": "Pi-shaped engineer: Backend/AI tooling Ã— AI agents/MCP Ã— Product iteration",
              "stats": { "years": 13, "commits": "5K+", "repos": 425, "stars": "1.8K" },
              "projects": [
                { "id": "project-key", "title": "Project Name", "description": "one line", "tech": "Go", "url": "https://...", "stars": 79 }
              ],
              "now": ["Current focus 1", "Current focus 2"],
              "links": {
                "github": "https://github.com/nguyenvanduocit",
                "twitter": "https://x.com/duocdev",
                "linkedin": "https://linkedin.com/in/duocnv",
                "blog": "https://12bit.vn",
                "website": "https://onepercent.plus"
              },
              "updated": "YYYY-MM-DD"
            }
            ```
            - Max 6 projects in profile.json
            - Keep descriptions short (under 50 chars)
            - Commit both README.md and profile.json
